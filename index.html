<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FX Sync Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/3.8.0/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #131722; color: #d1d4dc; font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; }
        header { background: #1e222d; padding: 10px; border-bottom: 1px solid #363c4e; height: 100px; }
        .controls { display: flex; flex-direction: column; gap: 8px; max-width: 600px; margin: 0 auto; }
        .input-row { display: flex; align-items: center; background: #2a2e39; padding: 5px 10px; border-radius: 4px; border: 1px solid #363c4e; }
        label { font-size: 11px; font-weight: bold; color: #2962ff; width: 70px; }
        input[type="file"] { font-size: 11px; color: #787b86; flex: 1; }
        #chart { width: 100vw; height: calc(100vh - 120px); }
        #status { font-size: 10px; color: #4caf50; text-align: center; background: #000; padding: 2px; height: 15px; }
    </style>
</head>
<body>
    <header>
        <div class="controls">
            <div class="input-row">
                <label>日足 CSV</label>
                <input type="file" id="d1_in" accept=".csv">
            </div>
            <div class="input-row">
                <label>1時間足 CSV</label>
                <input type="file" id="h1_in" accept=".csv">
            </div>
        </div>
    </header>
    <div id="status">CSVを選択してください</div>
    <div id="chart"></div>

    <script>
        const status = (m) => document.getElementById('status').innerText = m;

        // チャートの初期化
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            layout: { backgroundColor: '#131722', textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#2b2b43' }, horzLines: { color: '#2b2b43' } },
            timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#485c7b' },
            rightPriceScale: { borderColor: '#485c7b', autoScale: true },
            localization: { locale: 'ja-JP' }
        });

        const dailyLine = chart.addLineSeries({ color: '#2962ff', lineWidth: 3, title: '日足' });
        const hourlyLine = chart.addLineSeries({ color: '#ff9800', lineWidth: 1, title: '1時間' });

        // 安全に日付を秒単位のタイムスタンプに変換する関数
        function safeTimestamp(str) {
            // "2026-02-23" や "2026-02-23 10:00" をパース
            const parts = str.trim().split(/[ T]/); // 日付と時間を分ける
            const dateParts = parts[0].split(/[-/]/); // 年・月・日を分ける
            
            let y = parseInt(dateParts[0]), m = parseInt(dateParts[1]) - 1, d = parseInt(dateParts[2]);
            let hh = 0, mm = 0;

            if (parts.length > 1 && parts[1].includes(':')) {
                const timeParts = parts[1].split(':');
                hh = parseInt(timeParts[0]);
                mm = parseInt(timeParts[1]);
            }

            // ローカル時間を考慮してDateオブジェクトを作成
            const date = new Date(y, m, d, hh, mm, 0);
            const ts = Math.floor(date.getTime() / 1000);
            
            // JST/UTCのズレを補正（秒単位）
            return ts + (date.getTimezoneOffset() * -60);
        }

        function parse(text, isH) {
            const lines = text.split(/\r?\n/).filter(l => l.includes(','));
            const res = [];
            for (let i = 1; i < lines.length; i++) {
                const col = lines[i].split(',');
                if (col.length < 3) continue;
                
                const ts = safeTimestamp(col[0]);
                const val = parseFloat(col[2]);
                
                if (!isNaN(ts) && !isNaN(val)) {
                    res.push({ time: ts, value: val });
                }
            }
            // タイムスタンプ順に並び替え
            return res.sort((a, b) => a.time - b.time);
        }

        function setup(id, series, isH) {
            document.getElementById(id).addEventListener('change', (e) => {
                const f = e.target.files[0];
                if (!f) return;
                status(f.name + " 解析中...");
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const data = parse(ev.target.result, isH);
                        if (data.length > 0) {
                            series.setData(data);
                            status(f.name + " 完了: " + data.length + "件");
                        } else {
                            status("エラー: 有効なデータがありません");
                        }
                    } catch (err) {
                        status("実行エラー: " + err.message);
                    }
                };
                r.readAsText(f);
            });
        }

        setup('d1_in', dailyLine, false);
        setup('h1_in', hourlyLine, true);

        window.addEventListener('resize', () => {
            chart.applyOptions({ width: window.innerWidth, height: window.innerHeight - 120 });
        });
    </script>
</body>
</html>
