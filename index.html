<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Debug Mode</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #131722; color: white; font-family: sans-serif; padding: 10px; margin: 0; }
        .btn-box { background: #1e222d; padding: 15px; border-radius: 8px; border: 1px solid #363c4e; margin-bottom: 10px; }
        input[type="file"] { width: 100%; margin-top: 10px; color: white; }
        #log { 
            background: #000; color: #0f0; font-family: monospace; font-size: 11px; 
            padding: 10px; height: 120px; overflow-y: scroll; border: 1px solid #555; margin-bottom: 10px;
            white-space: pre-wrap; word-break: break-all;
        }
        #chart { width: 100%; height: 400px; }
    </style>
</head>
<body>
    <div class="btn-box">
        <div id="log">【システムログ】ここに状況が表示されます。ファイルを選択してください。</div>
        <label style="color:#2962ff; font-weight:bold;">1. 日足CSVを選択</label>
        <input type="file" id="d1" accept=".csv">
        <br><br>
        <label style="color:#ff9800; font-weight:bold;">2. 1時間足CSVを選択</label>
        <input type="file" id="h1" accept=".csv">
    </div>
    <div id="chart"></div>

    <script>
        const logEl = document.getElementById('log');
        function writeLog(msg) {
            const now = new Date();
            const time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
            logEl.innerText += "\n[" + time + "] " + msg;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        // チャート初期化
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            layout: { backgroundColor: '#131722', textColor: '#d1d4dc' },
            timeScale: { timeVisible: true }
        });
        const sD = chart.addLineSeries({ color: '#2962ff', title: '日足' });
        const sH = chart.addLineSeries({ color: '#ff9800', title: '1時間' });

        function processCSV(text, isH) {
            writeLog("解析開始...");
            const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
            writeLog("総行数: " + rows.length);
            
            const data = [];
            for(let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(',');
                if(cols.length < 3) continue;

                let tStr = cols[0].trim().replace(/-/g, '/');
                // 日付の解釈
                let dateObj = new Date(isH ? tStr : tStr + " 00:00:00");
                let t = Math.floor(dateObj.getTime() / 1000);

                if(!isNaN(t)) {
                    data.push({ time: t, value: parseFloat(cols[2]) });
                }
            }
            writeLog("有効データ件数: " + data.length);
            return data.sort((a,b) => a.time - b.time);
        }

        function setupListener(id, isH, series) {
            document.getElementById(id).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(!file) {
                    writeLog("ファイルが選択されていません");
                    return;
                }
                writeLog("ファイル検知: " + file.name + " (" + file.size + " bytes)");

                const reader = new FileReader();
                
                reader.onload = function(evt) {
                    writeLog("ファイル読み込み完了。パースします...");
                    try {
                        const result = processCSV(evt.target.result, isH);
                        if(result.length > 0) {
                            series.setData(result);
                            writeLog("チャートへの描画に成功しました！");
                        } else {
                            writeLog("エラー: 有効なデータが見つかりませんでした。");
                        }
                    } catch(err) {
                        writeLog("実行エラー: " + err.message);
                    }
                };

                reader.onerror = function() {
                    writeLog("ブラウザによる読み取りエラーが発生しました。");
                };

                try {
                    reader.readAsText(file);
                    writeLog("FileReaderを開始しました...");
                } catch(err) {
                    writeLog("FileReader起動失敗: " + err.message);
                }
            });
        }

        setupListener('d1', false, sD);
        setupListener('h1', true, sH);
    </script>
</body>
</html>
