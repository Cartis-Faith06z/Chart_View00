<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FX Bias Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #131722; color: #d1d4dc; font-family: sans-serif; overflow: hidden; }
        #header { height: 80px; padding: 10px; display: flex; flex-direction: column; justify-content: center; background: #1e222d; border-bottom: 1px solid #363c4e; }
        #controls { display: flex; gap: 15px; }
        #chart { width: 100vw; height: calc(100vh - 100px); }
        .input-group { display: flex; flex-direction: column; flex: 1; }
        /* スマホで押しやすいようにボタンを大きく */
        input[type="file"] { 
            font-size: 14px; 
            padding: 5px; 
            background: #2a2e39; 
            color: #d1d4dc; 
            border: 1px solid #363c4e; 
            border-radius: 4px;
        }
        label { font-weight: bold; margin-bottom: 5px; color: #2962ff; font-size: 12px; }
    </style>
</head>
<body>
    <div id="header">
        <div id="controls">
            <div class="input-group">
                <label>1. 日足CSV選択</label>
                <input type="file" id="dailyCsv" accept=".csv">
            </div>
            <div class="input-group">
                <label>2. 1時間足CSV選択</label>
                <input type="file" id="hourlyCsv" accept=".csv">
            </div>
        </div>
    </div>
    <div id="chart"></div>

    <script>
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            layout: { backgroundColor: '#131722', textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#2b2b43' }, horzLines: { color: '#2b2b43' } },
            timeScale: { timeVisible: true, secondsVisible: false, rightOffset: 5 }
        });

        const dailySeries = chart.addLineSeries({ color: '#2962ff', lineWidth: 3, title: '日足' });
        const h4Series = chart.addLineSeries({ color: '#f7525f', lineWidth: 2, title: '4時間' });
        const hourlySeries = chart.addLineSeries({ color: '#ff9800', lineWidth: 1, title: '1時間' });
        const smaSeries = chart.addLineSeries({ color: '#4caf50', lineWidth: 1, lineStyle: 2, title: '5-SMA' });

        function parseCSV(text, isHourly) {
            const lines = text.split(/\r?\n/);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (cols.length < 3) continue;
                
                let timeStr = cols[0].trim().replace(/-/g, '/');
                let time = isHourly ? Math.floor(new Date(timeStr).getTime() / 1000) 
                                   : Math.floor(new Date(timeStr + " 00:00").getTime() / 1000);
                
                if (isNaN(time)) continue;
                data.push({ time: time, value: parseFloat(cols[2]) });
            }
            return data.sort((a, b) => a.time - b.time);
        }

        // スマホで反応しやすくするための処理
        function handleFile(id, isHourly, series) {
            const input = document.getElementById(id);
            input.addEventListener('change', function(e) {
                if (!e.target.files.length) return;
                const reader = new FileReader();
                reader.onload = function() {
                    const data = parseCSV(reader.result, isHourly);
                    if (isHourly) {
                        hourlySeries.setData(data);
                        // 4時間足抽出
                        const h4Data = data.filter(d => new Date(d.time * 1000).getHours() % 4 === 0);
                        h4Series.setData(h4Data);
                        // 5-SMA
                        const smaData = [];
                        for (let i = 4; i < data.length; i++) {
                            const avg = (data[i].value + data[i-1].value + data[i-2].value + data[i-3].value + data[i-4].value) / 5;
                            smaData.push({ time: data[i].time, value: avg });
                        }
                        smaSeries.setData(smaData);
                    } else {
                        series.setData(data);
                    }
                    // 読み込み後に選択をリセット（同じファイルを再度選べるように）
                    input.value = ""; 
                };
                reader.readAsText(e.target.files[0]);
            });
        }

        handleFile('dailyCsv', false, dailySeries);
        handleFile('hourlyCsv', true, hourlySeries);

        window.addEventListener('resize', () => {
            chart.applyOptions({ width: window.innerWidth, height: window.innerHeight - 100 });
        });
    </script>
</body>
</html>