<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FX Bias Canvas</title>
    <style>
        body { background: #131722; color: white; font-family: sans-serif; margin: 0; padding: 10px; overflow: hidden; }
        .controls { background: #1e222d; padding: 10px; border-radius: 8px; border: 1px solid #363c4e; margin-bottom: 10px; }
        #log { background: #000; color: #0f0; font-family: monospace; font-size: 11px; padding: 8px; height: 80px; overflow-y: scroll; border: 1px solid #555; margin-bottom: 10px; white-space: pre-wrap; }
        input[type="file"] { width: 100%; margin-bottom: 10px; color: white; font-size: 14px; }
        canvas { background: #131722; border: 1px solid #363c4e; width: 100%; height: calc(100vh - 250px); }
    </style>
</head>
<body>
    <div class="controls">
        <div id="log">【ログ】ファイルを選択してください</div>
        <label style="color:#2962ff; font-size:12px;">D1 CSV:</label>
        <input type="file" id="d1" accept=".csv">
        <label style="color:#ff9800; font-size:12px;">H1 CSV:</label>
        <input type="file" id="h1" accept=".csv">
    </div>
    <canvas id="chartCanvas"></canvas>

    <script>
        const logEl = document.getElementById('log');
        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');
        let dailyData = [], hourlyData = [];

        function writeLog(msg) {
            logEl.innerText += "\n> " + msg;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // CSVパース (簡易版)
        function parseCSV(text) {
            const rows = text.split(/\r?\n/).filter(r => r.includes(','));
            const res = [];
            for (let i = 1; i < rows.length; i++) {
                const c = rows[i].split(',');
                if (c.length < 3) continue;
                const val = parseFloat(c[2]);
                if (!isNaN(val)) res.push(val);
            }
            return res; // 今回は時系列順に並んでいる前提で単純化
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (dailyData.length === 0 && hourlyData.length === 0) return;

            const maxData = Math.max(dailyData.length, hourlyData.length);
            const step = canvas.width / maxData;
            const yScale = canvas.height / 100; // 0-100%想定

            // ガイドライン (50%)
            ctx.strokeStyle = "#333";
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();

            // 1時間足 (オレンジ)
            if (hourlyData.length > 0) {
                ctx.strokeStyle = "#ff9800";
                ctx.lineWidth = 1;
                ctx.beginPath();
                hourlyData.forEach((v, i) => {
                    const x = i * (canvas.width / hourlyData.length);
                    const y = canvas.height - (v * yScale);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // 日足 (青)
            if (dailyData.length > 0) {
                ctx.strokeStyle = "#2962ff";
                ctx.lineWidth = 3;
                ctx.beginPath();
                dailyData.forEach((v, i) => {
                    const x = i * (canvas.width / dailyData.length);
                    const y = canvas.height - (v * yScale);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }
            writeLog("描画完了");
        }

        function init() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            document.getElementById('d1').onchange = e => {
                const f = e.target.files[0];
                writeLog("D1読み込み中...");
                const r = new FileReader();
                r.onload = () => { dailyData = parseCSV(r.result); writeLog("D1: " + dailyData.length + "件"); draw(); };
                r.readAsText(f);
            };

            document.getElementById('h1').onchange = e => {
                const f = e.target.files[0];
                writeLog("H1読み込み中...");
                const r = new FileReader();
                r.onload = () => { hourlyData = parseCSV(r.result); writeLog("H1: " + hourlyData.length + "件"); draw(); };
                r.readAsText(f);
            };
        }

        window.onload = init;
        window.onresize = () => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; draw(); };
    </script>
</body>
</html>
