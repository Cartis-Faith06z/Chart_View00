<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FX Bias Visualizer Pro</title>
<style>
:root { --bg: #131722; --panel: #1e222d; --text: #d1d4dc; --blue: #2962ff; --orange: #ff9800; --green: #4caf50; --grid: #2b2b43; }
body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; }

    header { padding: 12px; background: var(--panel); border-bottom: 1px solid #363c4e; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 900px; margin: 0 auto; }
    .input-group { display: flex; flex-direction: column; background: #2a2e39; padding: 10px; border-radius: 8px; border: 1px solid #444; }
    label { font-size: 12px; font-weight: bold; margin-bottom: 6px; color: var(--blue); }
    input[type="file"] { font-size: 13px; color: #787b86; cursor: pointer; }
    
    #log { background: #000; color: #0f0; font-family: monospace; font-size: 11px; padding: 6px 15px; height: 30px; overflow: hidden; border-bottom: 1px solid #333; }
    
    .chart-container { position: relative; width: 100vw; height: calc(100vh - 180px); }
    canvas { width: 100%; height: 100%; touch-action: none; }
    
    .legend { display: flex; justify-content: center; gap: 20px; padding: 10px; background: var(--panel); font-size: 12px; border-top: 1px solid #363c4e; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .line-sample { width: 20px; height: 3px; border-radius: 2px; }
</style>


</head>
<body>

<header>
<div class="controls">
<div class="input-group">
<label>1. 日足 (D1) CSVを選択</label>
<input type="file" id="fileD1" accept=".csv">
</div>
<div class="input-group">
<label>2. 1時間足 (H1) CSVを選択</label>
<input type="file" id="fileH1" accept=".csv">
</div>
</div>
</header>

<div id="log">ログ: 1時間足CSVを優先して読み込んでください...</div>

<div class="chart-container">
<canvas id="chartCanvas"></canvas>
</div>

<div class="legend">
<div class="legend-item"><div class="line-sample" style="background:var(--blue)"></div>日足</div>
<div class="legend-item"><div class="line-sample" style="background:var(--orange)"></div>1時間</div>
<div class="legend-item"><div class="line-sample" style="background:var(--green); border-top:1px dashed white"></div>5SMA (1H)</div>
</div>

<script>
const canvas = document.getElementById('chartCanvas');
const ctx = canvas.getContext('2d');
const logEl = document.getElementById('log');

let dataD1 = [], dataH1 = [], dataSMA = [];
let viewMinTime = 0, viewMaxTime = 0;

function writeLog(m) {
    logEl.innerText = &quot;ログ: &quot; + m;
}

// どんな日付形式でもUnix秒に変換
function parseDate(s) {
    const str = s.trim().replace(/-/g, &#39;/&#39;);
    const dt = new Date(str.includes(&#39; &#39;) ? str : str + &quot; 00:00:00&quot;);
    return Math.floor(dt.getTime() / 1000);
}

function parseCSV(text) {
    const rows = text.split(/\r?\n/).filter(r =&gt; r.includes(&#39;,&#39;));
    const result = [];
    for (let i = 1; i &lt; rows.length; i++) {
        const cols = rows[i].split(&#39;,&#39;);
        if (cols.length &lt; 3) continue;
        const t = parseDate(cols[0]);
        const v = parseFloat(cols[2]);
        if (!isNaN(t) &amp;&amp; !isNaN(v)) {
            result.push({ t, v });
        }
    }
    return result.sort((a, b) =&gt; a.t - b.t);
}

function calculateSMA(data, period) {
    const res = [];
    for (let i = period - 1; i &lt; data.length; i++) {
        let sum = 0;
        for (let j = 0; j &lt; period; j++) sum += data[i - j].v;
        res.push({ t: data[i].t, v: sum / period });
    }
    return res;
}

function draw() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = canvas.offsetWidth * dpr;
    canvas.height = canvas.offsetHeight * dpr;
    ctx.scale(dpr, dpr);
    
    const w = canvas.offsetWidth;
    const h = canvas.offsetHeight;
    const pad = { top: 30, right: 60, bottom: 40, left: 10 };

    ctx.clearRect(0, 0, w, h);

    // 1時間足があれば、その期間にズーム。なければ日足。
    if (dataH1.length &gt; 0) {
        viewMinTime = dataH1[0].t;
        viewMaxTime = dataH1[dataH1.length - 1].t;
    } else if (dataD1.length &gt; 0) {
        viewMinTime = dataD1[0].t;
        viewMaxTime = dataD1[dataD1.length - 1].t;
    } else {
        return;
    }

    const timeRange = viewMaxTime - viewMinTime || 1;
    const xMap = (t) =&gt; pad.left + (t - viewMinTime) / timeRange * (w - pad.left - pad.right);
    const yMap = (v) =&gt; pad.top + (1 - v / 100) * (h - pad.top - pad.bottom);

    // グリッド線（横軸：％）
    ctx.strokeStyle = &quot;#2b2b43&quot;;
    ctx.lineWidth = 1;
    ctx.textAlign = &quot;right&quot;;
    ctx.textBaseline = &quot;middle&quot;;
    for (let i = 0; i &lt;= 10; i++) {
        const val = i * 10;
        const y = yMap(val);
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(w - pad.right, y);
        ctx.stroke();
        
        ctx.fillStyle = &quot;#787b86&quot;;
        ctx.font = &quot;11px sans-serif&quot;;
        ctx.fillText(val + &quot;%&quot;, w - 5, y);
    }

    // 縦軸（日付ラベル：3日おき程度）
    ctx.textAlign = &quot;center&quot;;
    const daySec = 86400;
    let lastLabelX = -100;
    for (let t = viewMinTime; t &lt;= viewMaxTime; t += daySec) {
        const x = xMap(t);
        if (x &lt; pad.left || x &gt; w - pad.right) continue;
        
        // 日別のグリッド線
        ctx.strokeStyle = &quot;#1e222d&quot;;
        ctx.beginPath();
        ctx.moveTo(x, pad.top);
        ctx.lineTo(x, h - pad.bottom);
        ctx.stroke();

        // ラベル（重ならないように）
        if (x - lastLabelX &gt; 60) {
            const d = new Date(t * 1000);
            const label = (d.getMonth() + 1) + &quot;/&quot; + d.getDate();
            ctx.fillStyle = &quot;#787b86&quot;;
            ctx.fillText(label, x, h - 15);
            lastLabelX = x;
        }
    }

    const drawLine = (data, color, width, isDashed = false) =&gt; {
        const visibleData = data.filter(p =&gt; p.t &gt;= viewMinTime &amp;&amp; p.t &lt;= viewMaxTime);
        if (visibleData.length &lt; 2) return;
        
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        if (isDashed) ctx.setLineDash([4, 4]); else ctx.setLineDash([]);
        
        ctx.beginPath();
        visibleData.forEach((p, i) =&gt; {
            const x = xMap(p.t);
            const y = yMap(p.v);
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
    };

    // 描画順：1H -&gt; SMA -&gt; D1 (日足を一番上に)
    drawLine(dataH1, &quot;#ff9800&quot;, 1.2);
    drawLine(dataSMA, &quot;#4caf50&quot;, 1, true);
    drawLine(dataD1, &quot;#2962ff&quot;, 3);
}

function init() {
    document.getElementById(&#39;fileD1&#39;).onchange = e =&gt; {
        if (!e.target.files.length) return;
        const r = new FileReader();
        r.onload = () =&gt; { 
            dataD1 = parseCSV(r.result); 
            writeLog(&quot;日足読込完了。&quot;); 
            draw(); 
        };
        r.readAsText(e.target.files[0]);
    };
    document.getElementById(&#39;fileH1&#39;).onchange = e =&gt; {
        if (!e.target.files.length) return;
        const r = new FileReader();
        r.onload = () =&gt; {
            dataH1 = parseCSV(r.result);
            dataSMA = calculateSMA(dataH1, 5);
            writeLog(&quot;1時間足読込完了（表示範囲を最適化しました）&quot;);
            draw();
        };
        r.readAsText(e.target.files[0]);
    };
}

window.onload = init;
window.onresize = draw;


</script>

</body>
</html>
